<% content_for :header_title do %>Sammanställning<% end %>

<script src="https://checkout.stripe.com/checkout.js"></script>

<div class="container">
  <table>
    <thead>
    <tr>
      <th>Artikel</th>
      <th class="right">Pris</th>
    </tr>
    </thead>
    <tbody>
    <% @cart['cart_items'].each do |item| %>
        <tr>
          <% if item['product']['kind'].nil? %>
              <td><%= item['product']['base_product']['name'] %></td>
          <% else %>
              <td><%= "#{item['product']['base_product']['name']} (#{item['product']['kind']})" %></td>
          <% end %>
          <td class="right"><%= item['product']['base_product']['cost'] %> SEK</td>
        </tr>
    <% end %>
    <tr>
      <th>Totalt</th>
      <th class="right"><%= @total %> SEK</th>
    </tr>
    </tbody>
  </table>

  <br/>

  <a class="btn green" id="checkout-button">Betala</a>
</div>

<form id="stripe-form" method="post" action="<%= url_for action: :charge %>">
  <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
  <input id="stripe-token" type="hidden" name="stripe_token"/>
</form>

<script>
    var handler = StripeCheckout.configure({
        key: '<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>',
        image: 'https://s3-eu-west-1.amazonaws.com/lintek-sof/webapp/logotyper/sof/hjartat_2.png',
        locale: 'sv',
        token: function(token) {
            $('#stripe-token').val(token);
            $('#stripe-form').submit();
        }
    });

    document.getElementById('checkout-button').addEventListener('click', function(e) {
        // Open Checkout with further options:
        handler.open({
            name: 'LinTek',
            description: 'Köp på www.sof17.se',
            amount: <%= @total * 100 %>,
            currency: 'sek',
            email: '<%=	current_user['email'] %>'
        });
        e.preventDefault();
    });

    window.addEventListener('popstate', function() {
        handler.close();
    });
</script>
